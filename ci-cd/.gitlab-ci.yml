image: docker:latest
services:
  - docker:dind

variables:
  REGISTRY: localhost:5000
  IMAGE_NAME: 25rp19452-niyonkuru/helpdesk
  VERSION: "1.0.0"
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

stages:
  - test
  - build
  - deploy-dev
  - deploy-prod

before_script:
  - echo "Starting pipeline for 25RP19452-NIYONKURU"

test:
  stage: test
  image: python:3.11-slim
  script:
    - echo "Running unit tests..."
    - pip install -r requirements.txt pytest pytest-cov
    - pytest tests/ -v --cov=src --cov-report=term-summary
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 1 day
  cache:
    paths:
      - .pip-cache/
  only:
    - branches

build:
  stage: build
  script:
    - echo "Building Docker image for 25RP19452-NIYONKURU"
    - docker build -f docker/Dockerfile -t $REGISTRY/$IMAGE_NAME:$VERSION -t $REGISTRY/$IMAGE_NAME:latest .
    - echo "Image built successfully: $REGISTRY/$IMAGE_NAME:$VERSION"
  after_script:
    - docker images | grep 25rp19452-niyonkuru
  only:
    - develop
    - main
  tags:
    - docker

scan:
  stage: build
  image: aquasec/trivy:latest
  script:
    - echo "Scanning Docker image for vulnerabilities..."
    - trivy image --exit-code 0 $REGISTRY/$IMAGE_NAME:$VERSION || true
  allow_failure: true
  only:
    - develop
    - main

deploy-dev:
  stage: deploy-dev
  image: bitnami/kubectl:latest
  script:
    - echo "Deploying to development environment..."
    - kubectl apply -f kubernetes/namespace.yaml
    - kubectl apply -f kubernetes/ -n 25rp19452-niyonkuru
    - kubectl rollout status deployment/helpdesk-app -n 25rp19452-niyonkuru
  only:
    - develop
  environment:
    name: development
    kubernetes:
      namespace: 25rp19452-niyonkuru
  tags:
    - kubernetes

deploy-prod:
  stage: deploy-prod
  image: bitnami/kubectl:latest
  script:
    - echo "Deploying to production environment..."
    - kubectl apply -f kubernetes/namespace.yaml
    - kubectl apply -f kubernetes/ -n 25rp19452-niyonkuru
    - kubectl rollout status deployment/helpdesk-app -n 25rp19452-niyonkuru
  only:
    - main
  when: manual
  environment:
    name: production
    kubernetes:
      namespace: 25rp19452-niyonkuru
  tags:
    - kubernetes

after_script:
  - echo "Pipeline completed for 25RP19452-NIYONKURU"
